name: Build MSIX for Microsoft Store

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-msix:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc,wasm32-unknown-unknown

    - name: Rust cache
      uses: swatinem/rust-cache@v2
      with:
        workspaces: ". -> target"

    - name: Install trunk
      run: cargo install trunk

    - name: Install Python for sidecars
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Prepare sidecars
      run: .\run.ps1 -SidecarsOnly
      shell: pwsh

    - name: Build Tauri app (MSI)
      uses: tauri-apps/tauri-action@v0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        args: --target x86_64-pc-windows-msvc

    - name: Find MSI file
      id: find-msi
      run: |
        $msiPath = Get-ChildItem -Path "target" -Recurse -Filter "*.msi" -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
        if ($msiPath) {
          echo "msi_path=$msiPath" >> $env:GITHUB_OUTPUT
          $msiName = [System.IO.Path]::GetFileName($msiPath)
          echo "msi_name=$msiName" >> $env:GITHUB_OUTPUT
          Write-Host "Found MSI at: $msiPath"
        } else {
          Write-Error "MSI file not found under target\"
          exit 1
        }
      shell: pwsh

    - name: Create MSIX package
      id: create-msix
      shell: pwsh
      run: |
        $msiPath = "${{ steps.find-msi.outputs.msi_path }}"

        # Extract MSI contents via administrative install
        $extractDir = "$PWD\msi-extracted"
        Write-Host "Extracting MSI to $extractDir ..."
        Start-Process msiexec.exe -ArgumentList "/a `"$msiPath`" /qn TARGETDIR=`"$extractDir`"" -Wait -NoNewWindow

        # Locate the app executable inside the extracted MSI
        $appExe = Get-ChildItem -Path $extractDir -Recurse -Filter "ClipDownloader.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $appExe) {
          $appExe = Get-ChildItem -Path $extractDir -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -notmatch 'ffmpeg|ffprobe|yt-dlp|gallery-dl' } |
            Select-Object -First 1
        }
        if (-not $appExe) { throw "Could not find app executable in extracted MSI" }
        $appDir = $appExe.DirectoryName
        Write-Host "App directory: $appDir"

        # Build MSIX layout
        $layout = "$PWD\msix-layout"
        New-Item -ItemType Directory -Path $layout -Force | Out-Null
        New-Item -ItemType Directory -Path "$layout\Assets" -Force | Out-Null

        # Copy all app files
        Copy-Item "$appDir\*" $layout -Recurse -Force

        # Copy MSIX icons from source
        $iconSrc = "src-tauri\icons"
        Copy-Item "$iconSrc\StoreLogo.png"        "$layout\Assets\StoreLogo.png"
        Copy-Item "$iconSrc\Square44x44Logo.png"  "$layout\Assets\Square44x44Logo.png"
        Copy-Item "$iconSrc\Square150x150Logo.png" "$layout\Assets\Square150x150Logo.png"

        # Create AppxManifest.xml
        @"
        <?xml version="1.0" encoding="utf-8"?>
        <Package xmlns="http://schemas.microsoft.com/appx/manifest/foundation/windows10"
                 xmlns:uap="http://schemas.microsoft.com/appx/manifest/uap/windows10"
                 xmlns:rescap="http://schemas.microsoft.com/appx/manifest/foundation/windows10/restrictedcapabilities">
          <Identity Name="com.hjoncour.clip-downloader"
                    Publisher="CN=hjoncour"
                    Version="0.1.0.0"
                    ProcessorArchitecture="x64" />
          <Properties>
            <DisplayName>ClipDownloader</DisplayName>
            <PublisherDisplayName>hjoncour</PublisherDisplayName>
            <Description>Download content from YouTube, TikTok, Instagram, Pinterest</Description>
            <Logo>Assets\StoreLogo.png</Logo>
          </Properties>
          <Dependencies>
            <TargetDeviceFamily Name="Windows.Desktop" MinVersion="10.0.17763.0" MaxVersionTested="10.0.22621.0" />
          </Dependencies>
          <Resources>
            <Resource Language="en-us" />
          </Resources>
          <Applications>
            <Application Id="ClipDownloader"
                         Executable="$($appExe.Name)"
                         EntryPoint="Windows.FullTrustApplication">
              <uap:VisualElements DisplayName="ClipDownloader"
                                  Description="Download content from YouTube, TikTok, Instagram, Pinterest"
                                  Square150x150Logo="Assets\Square150x150Logo.png"
                                  Square44x44Logo="Assets\Square44x44Logo.png"
                                  BackgroundColor="transparent" />
            </Application>
          </Applications>
          <Capabilities>
            <rescap:Capability Name="runFullTrust" />
            <Capability Name="internetClient" />
          </Capabilities>
        </Package>
        "@ | Out-File -FilePath "$layout\AppxManifest.xml" -Encoding UTF8

        # Find makeappx.exe from Windows SDK
        $makeAppx = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin\10.*\x64\makeappx.exe" |
          Sort-Object { [version]($_.Directory.Parent.Name) } -Descending |
          Select-Object -First 1 -ExpandProperty FullName
        Write-Host "Using makeappx: $makeAppx"

        # Create MSIX
        $msixName = "ClipDownloader_0.1.0.0_x64.msix"
        & $makeAppx pack /d $layout /p $msixName /nv
        if (-not (Test-Path $msixName)) { throw "makeappx failed to create $msixName" }

        Write-Host "MSIX created: $msixName"
        echo "msix_name=$msixName" >> $env:GITHUB_OUTPUT
        echo "msix_name=$msixName" >> $env:GITHUB_ENV

    - name: Azure Login (uses AZURE_CREDENTIALS secret)
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Install AzureSignTool
      run: dotnet tool install --global AzureSignTool

    - name: Sign MSIX (Key Vault)
      shell: pwsh
      env:
        AZURE_KEYVAULT_NAME: ${{ secrets.AZURE_KEYVAULT_NAME }}
        AZURE_CERT_NAME: ${{ secrets.AZURE_CERT_NAME }}
      run: |
        $msixName = $env:msix_name
        if (-not $msixName) {
          # fallback: find any msix in current directory
          $msix = Get-ChildItem -Path "." -Filter "*.msix" | Select-Object -First 1
          if (-not $msix) { throw "No MSIX found to sign" }
          $msixName = $msix.Name
        }

        $msixPath = Join-Path $PWD $msixName
        if (-not (Test-Path $msixPath)) { throw "MSIX path not found: $msixPath" }

        # Timestamp server (recommended)
        $ts = "http://timestamp.digicert.com"

        # Build vault URL safely
        $vaultName = $env:AZURE_KEYVAULT_NAME
        $certName = $env:AZURE_CERT_NAME
        if (-not $vaultName) { throw "AZURE_KEYVAULT_NAME secret is not set" }
        if (-not $certName) { throw "AZURE_CERT_NAME secret is not set" }
        $vaultUrl = "https://" + $vaultName + ".vault.azure.net/"
        Write-Host "Vault URL: $vaultUrl"

        # Get access token from Azure CLI login
        $token = az account get-access-token --resource "https://vault.azure.net" --query accessToken -o tsv

        # Sign using Key Vault cert (private key stays in Azure)
        AzureSignTool sign `
          -kvu $vaultUrl `
          -kvc $certName `
          -kva $token `
          -tr $ts `
          -td sha256 `
          -fd sha256 `
          $msixPath

        if ($LASTEXITCODE -ne 0) { throw "AzureSignTool failed with exit code $LASTEXITCODE" }
        Write-Host "Signed MSIX: $msixPath"

    - name: Upload MSIX artifact
      uses: actions/upload-artifact@v4
      with:
        name: clip-downloader-msix
        path: "*.msix"
        retention-days: 30

    - name: Upload MSI artifact (backup)
      uses: actions/upload-artifact@v4
      with:
        name: clip-downloader-msi
        path: target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
        retention-days: 30
