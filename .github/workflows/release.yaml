name: Release on PR merge or [release] commit (Tauri - macOS ARM/Intel, Windows, Linux)

on:
  # Run when a PR into master is merged (regardless of source branch)
  pull_request:
    types: [closed]
    branches: [master]

  # Run on ANY push to ANY branch (we'll gate with an `if:` on the job)
  push: {}

  # Manual trigger (just in case)
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.head_ref || github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build:
    # Gate: merged PR to master OR push whose HEAD commit contains [release]
    if: |
      (github.event_name == 'pull_request' &&
       github.event.action == 'closed' &&
       github.event.pull_request.merged == true &&
       !contains(github.event.pull_request.title, '[no-release]'))
      ||
      (github.event_name == 'push' &&
       contains(github.event.head_commit.message, '[release]'))

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            label: macos-arm64
            triple: aarch64-apple-darwin
          - os: macos-13
            label: macos-x86_64
            triple: x86_64-apple-darwin
          - os: windows-latest
            label: windows-x86_64
            triple: x86_64-pc-windows-msvc
          # - os: ubuntu-20.04
          #   label: linux-x86_64
          #   triple: x86_64-unknown-linux-gnu
    runs-on: ${{ matrix.os }}

    env:
      CARGO_TERM_COLOR: always
      BUNDLE_DIR: target/release/bundle
      BIN_DIR: src-tauri/binaries
      RES_DIR: src-tauri/resources

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo binaries
        id: cache-cargo-binaries
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-${{ runner.arch }}-cargo-binaries-v1-${{ hashFiles('.github/workflows/release.yaml') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-cargo-binaries-v1-

      - name: Install cargo tools (if not cached) (Unix)
        if: runner.os != 'Windows'
        run: |
          if ! command -v trunk &> /dev/null; then cargo install --locked trunk; fi
          if ! command -v wasm-bindgen &> /dev/null; then cargo install --locked wasm-bindgen-cli; fi
          if ! command -v cargo-tauri &> /dev/null; then cargo install --locked tauri-cli --version "^2.0.0-beta"; fi

      - name: Install cargo tools (if not cached) (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          if (-not (Get-Command trunk -ErrorAction SilentlyContinue)) { cargo install --locked trunk }
          if (-not (Get-Command wasm-bindgen -ErrorAction SilentlyContinue)) { cargo install --locked wasm-bindgen-cli }
          if (-not (Get-Command cargo-tauri -ErrorAction SilentlyContinue)) { cargo install --locked tauri-cli --version "^2.0.0-beta" }

      - name: macOS ffmpeg
        if: startsWith(matrix.os, 'macos')
        run: brew install ffmpeg || true

      - name: Windows ffmpeg
        if: startsWith(matrix.os, 'windows')
        shell: powershell
        run: choco install ffmpeg -y --no-progress

      # -------- Sidecars (Linux/macOS) --------
      - name: Prepare sidecars (Linux/macOS)
        if: startsWith(matrix.os, 'ubuntu') || startsWith(matrix.os, 'macos')
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$BIN_DIR" "$RES_DIR"

          # yt-dlp
          if [[ "${{ matrix.label }}" == macos-* ]]; then
            curl -L "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp_macos" -o "$BIN_DIR/yt-dlp-${{ matrix.triple }}"
            chmod +x "$BIN_DIR/yt-dlp-${{ matrix.triple }}"
            xattr -c "$BIN_DIR/yt-dlp-${{ matrix.triple }}"
          else
            curl -L "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp" -o "$BIN_DIR/yt-dlp-${{ matrix.triple }}"
            chmod +x "$BIN_DIR/yt-dlp-${{ matrix.triple }}"
          fi

          # ffmpeg/ffprobe → resources (unsuffixed) AND binaries/ (suffixed + unsuffixed)
          cp "$(which ffmpeg)" "$RES_DIR/ffmpeg"
          cp "$(which ffmpeg)" "$BIN_DIR/ffmpeg-${{ matrix.triple }}"
          cp "$(dirname "$(which ffmpeg)")/ffprobe" "$RES_DIR/ffprobe"
          cp "$(dirname "$(which ffmpeg)")/ffprobe" "$BIN_DIR/ffprobe-${{ matrix.triple }}"

          # gallery-dl onefile (PyInstaller)
          python3 -m venv .venv
          source .venv/bin/activate
          python3 -m pip install --upgrade pip wheel setuptools pyinstaller gallery-dl
          MAIN=$(python3 - <<'PY'
          import gallery_dl, inspect, os
          print(os.path.join(os.path.dirname(inspect.getfile(gallery_dl)),"__main__.py"))
          PY
          )
          pyinstaller --onefile --name "gallery-dl-${{ matrix.triple }}" "$MAIN" \
            --additional-hooks-dir pyinstaller-hooks \
            --runtime-hook pyinstaller-hooks/rthook-gallery-dl.py \
            --collect-submodules gallery_dl.extractor \
            --collect-submodules gallery_dl.downloader \
            --collect-submodules gallery_dl.postprocessor \
            --collect-submodules gallery_dl.output \
            --collect-data gallery_dl
          mv "dist/gallery-dl-${{ matrix.triple }}" "$BIN_DIR/"
          if [[ "${{ matrix.label }}" == macos-* ]]; then
            xattr -c "$BIN_DIR/gallery-dl-${{ matrix.triple }}"
          fi

          # Unsuffixed copies for externalBin
          cp "$BIN_DIR/yt-dlp-${{ matrix.triple }}" "$BIN_DIR/yt-dlp"
          cp "$BIN_DIR/ffmpeg-${{ matrix.triple }}" "$BIN_DIR/ffmpeg"
          cp "$BIN_DIR/ffprobe-${{ matrix.triple }}" "$BIN_DIR/ffprobe"
          cp "$BIN_DIR/gallery-dl-${{ matrix.triple }}" "$BIN_DIR/gallery-dl"

      # -------- Sidecars (Windows) --------
      - name: Prepare sidecars (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path $env:BIN_DIR, $env:RES_DIR | Out-Null

          Invoke-WebRequest "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -OutFile "$env:BIN_DIR\yt-dlp-${{ matrix.triple }}.exe"

          Copy-Item (Get-Command ffmpeg).Source "$env:RES_DIR\ffmpeg.exe"
          Copy-Item (Get-Command ffmpeg).Source "$env:BIN_DIR\ffmpeg-${{ matrix.triple }}.exe"
          Copy-Item (Join-Path (Split-Path (Get-Command ffmpeg).Source) "ffprobe.exe") "$env:RES_DIR\ffprobe.exe"
          Copy-Item (Join-Path (Split-Path (Get-Command ffmpeg).Source) "ffprobe.exe") "$env:BIN_DIR\ffprobe-${{ matrix.triple }}.exe"

          py -m venv .venv
          .\.venv\Scripts\Activate.ps1
          py -m pip install --upgrade pip wheel setuptools pyinstaller gallery-dl
          $main = py -c "import gallery_dl, inspect, os; print(os.path.join(os.path.dirname(inspect.getfile(gallery_dl)), '__main__.py'))"
          py -m PyInstaller --onefile --name "gallery-dl-${{ matrix.triple }}" "$main" `
            --additional-hooks-dir pyinstaller-hooks `
            --runtime-hook pyinstaller-hooks/rthook-gallery-dl.py `
            --collect-submodules gallery_dl.extractor `
            --collect-submodules gallery_dl.downloader `
            --collect-submodules gallery_dl.postprocessor `
            --collect-submodules gallery_dl.output `
            --collect-data gallery_dl
          Move-Item ".\dist\gallery-dl-${{ matrix.triple }}.exe" "$env:BIN_DIR\"

          Copy-Item "$env:BIN_DIR\yt-dlp-${{ matrix.triple }}.exe" "$env:BIN_DIR\yt-dlp.exe"
          Copy-Item "$env:BIN_DIR\ffmpeg-${{ matrix.triple }}.exe" "$env:BIN_DIR\ffmpeg.exe"
          Copy-Item "$env:BIN_DIR\ffprobe-${{ matrix.triple }}.exe" "$env:BIN_DIR\ffprobe.exe"
          Copy-Item "$env:BIN_DIR\gallery-dl-${{ matrix.triple }}.exe" "$env:BIN_DIR\gallery-dl.exe"

      - name: Build frontend (Trunk)
        run: trunk build --release

      # --- macOS certificate import ---
      - name: Import Apple Developer certificate (macOS)
        if: startsWith(matrix.os, 'macos')
        shell: bash
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}             # base64 of .p12
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          set -euxo pipefail
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12

          KEYCHAIN_PATH="$HOME/Library/Keychains/build.keychain-db"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -t 3600 -u "$KEYCHAIN_PATH"

          security import certificate.p12 -k "$KEYCHAIN_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign -T /usr/bin/security -T /usr/bin/productbuild -T /usr/bin/xcrun

          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH" || true

          echo "== code signing identities =="
          security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true

          CERT_ID=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep 'Developer ID Application' | head -n1 | awk -F\" '{print $2}' || true)
          if [[ -z "$CERT_ID" ]]; then
            echo "::error::Developer ID Application identity not found in the imported .p12"
            exit 1
          fi
          echo "APPLE_SIGNING_IDENTITY=$CERT_ID" >> $GITHUB_ENV

      - name: Write API key file (macOS)
        if: startsWith(matrix.os, 'macos')
        shell: bash
        env:
          APPLE_API_KEY_P8: ${{ secrets.APPLE_API_KEY_P8 }}
        run: |
          set -euo pipefail
          if [[ -n "${APPLE_API_KEY_P8:-}" ]]; then
            printf "%s" "$APPLE_API_KEY_P8" > AuthKey.p8
          fi

      - name: Build Tauri app (signed; no built-in wait)
        timeout-minutes: 40
        env:
          APPLE_SIGNING_IDENTITY: ${{ env.APPLE_SIGNING_IDENTITY }}
          APPLE_API_ISSUER: ''
          APPLE_API_KEY: ''
          APPLE_API_KEY_PATH: ''
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cargo tauri build --ci --verbose
          echo "---- Bundles ----"
          ls -R "$BUNDLE_DIR" || true

      - name: Notarize DMG via API key (macOS)
        if: startsWith(matrix.os, 'macos') && secrets.APPLE_API_KEY_P8 != ''
        shell: bash
        timeout-minutes: 30
        env:
          APPLE_API_KEY:      ${{ secrets.APPLE_API_KEY }}
          APPLE_API_ISSUER:   ${{ secrets.APPLE_API_ISSUER }}
        run: |
          set -euxo pipefail
          DMG_PATH=$(ls "$BUNDLE_DIR/macos/"*.dmg | head -n1)
          echo "DMG_PATH=$DMG_PATH"
          ls -lh "$DMG_PATH"

          xcrun notarytool history --key ./AuthKey.p8 --key-id "$APPLE_API_KEY" --issuer "$APPLE_API_ISSUER" --output-format json > /dev/null || true

          xcrun notarytool submit "$DMG_PATH" \
            --key ./AuthKey.p8 \
            --key-id "$APPLE_API_KEY" \
            --issuer "$APPLE_API_ISSUER" \
            --wait \
            --output-format json | tee notary-result.json

      - name: Staple notarization ticket (macOS)
        if: startsWith(matrix.os, 'macos') && secrets.APPLE_API_KEY_P8 != ''
        shell: bash
        run: |
          set -euxo pipefail
          DMG_PATH=$(ls "$BUNDLE_DIR/macos/"*.dmg | head -n1)
          APP_PATH=$(ls -d "$BUNDLE_DIR/macos/"*.app | head -n1 || true)

          xcrun stapler staple -v "$DMG_PATH" || true
          if [[ -n "${APP_PATH:-}" ]]; then
            xcrun stapler staple -v "$APP_PATH" || true
          fi

      - name: Verify code signatures (macOS)
        if: startsWith(matrix.os, 'macos')
        shell: bash
        run: |
          set -euxo pipefail
          APP_PATH=$(ls -d "$BUNDLE_DIR/macos/"*.app | head -n1)
          codesign --verify --deep --strict --verbose=4 "$APP_PATH"
          spctl --assess --type execute --verbose=4 "$APP_PATH" || true

      - name: Cleanup keychain (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          security delete-keychain "$HOME/Library/Keychains/build.keychain-db" || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bundles-${{ matrix.label }}
          path: ${{ env.BUNDLE_DIR }}/**/*
          if-no-files-found: error
          retention-days: 7

  publish:
    needs: [build]
    if: |
      always() && (
        (github.event_name == 'pull_request' &&
         github.event.action == 'closed' &&
         github.event.pull_request.merged == true &&
         !contains(github.event.pull_request.title, '[no-release]'))
        ||
        (github.event_name == 'push' &&
         contains(github.event.head_commit.message, '[release]'))
      )
    runs-on: ubuntu-latest
    steps:
      - name: Check build job conclusion
        if: needs.build.result != 'success'
        run: |
          echo "One or more build jobs failed. Skipping release."
          exit 1

      - name: Find Pull Request
        id: find_pr
        if: github.event_name == 'push'
        uses: jwalton/gh-find-current-pr@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Derive release metadata
        id: meta
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "tag=vpr-${{ github.event.pull_request.number }}-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
            echo "name=PR #${{ github.event.pull_request.number }} — ${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
          elif [ -n "${{ steps.find_pr.outputs.number }}" ]; then
            PR_NUMBER="${{ steps.find_pr.outputs.number }}"
            COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | sed 's/$begin:math:display$release$end:math:display$//g' | xargs)
            echo "tag=vpr-${PR_NUMBER}-commit-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
            echo "name=PR #${PR_NUMBER} — $COMMIT_MSG" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
          else
            COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | sed 's/$begin:math:display$release$end:math:display$//g' | xargs)
            echo "tag=v$(date +'%Y.%m.%d')-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
            echo "name=$COMMIT_MSG" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
          fi

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          draft: ${{ steps.meta.outputs.draft }}
          prerelease: ${{ steps.meta.outputs.prerelease }}
          generate_release_notes: true
          files: |
            dist/**/*.dmg
            dist/**/*.msi
            dist/**/*-setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
